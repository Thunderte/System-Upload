<?php
class User {
    public static function login(){
        global $dbh;
        if(isset($_POST['login'])) {
                if(!$_POST['username']){
                    echo '<div id="toast-danger" class="flex items-center p-4 mb-4 w-full max-w-xs text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex flex-shrink-0 justify-center items-center w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            <span class="sr-only">Error icon</span>
        </div>
        <div class="ml-3 text-sm font-normal">Digite um usuário!</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-danger" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>';
                } else if(!$_POST['password']){
                    echo '<div id="toast-danger" class="flex items-center p-4 mb-4 w-full max-w-xs text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex flex-shrink-0 justify-center items-center w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            <span class="sr-only">Error icon</span>
        </div>
        <div class="ml-3 text-sm font-normal">Digite uma senha!</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-danger" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>';
                }
                else{
                    $password = md5(sha1($_POST['password']));
                    $sql = $dbh->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
                    $sql->bindParam(':username', $_POST['username']);
                    $sql->bindParam(':password', $password);
                    $sql->execute();

                    $total_registros = $sql->rowCount();

                    if($total_registros == 1 ){
                        $user = $sql->fetch();

                        $sql2 = $dbh->prepare('UPDATE users SET log_ip = :ip WHERE username = :username');
                        $sql2->bindParam(':ip', $_SERVER['HTTP_CF_CONNECTING_IP']);
                        $sql2->bindParam(':username', $user['username']);
                        $sql2->execute();


                        $mensagem =  "O usuário ". $_POST['username']. " fez login com o ip ". $_SERVER['HTTP_CF_CONNECTING_IP'];
                        $tipo = "Login";

                        $logs = $dbh->prepare('INSERT INTO logs(tipo, mensagem, author, data) VALUES (?, ?, ?, ?)');
                        $logs->bindValue(1, $tipo);
                        $logs->bindValue(2, $mensagem);
                        $logs->bindValue(3, $_POST['username']);
                        $logs->bindValue(4, date('d/m/Y H:i'));
                        $logs->execute();


                        if(!isset($_SESSION)){
                            session_start();
                        }

                        $_SESSION['id'] = $user['id'];
                        $_SESSION['username'] = $user['username'];
                        $_SESSION['rank'] = $user['rank'];

                        header('Location: upload');
                    }
                    if($total_registros == 0){
                        echo '<div id="toast-danger" class="flex items-center p-4 mb-4 w-full max-w-xs text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex flex-shrink-0 justify-center items-center w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            <span class="sr-only">Error icon</span>
        </div>
        <div class="ml-3 text-sm font-normal">Usuário ou senha incorretos!</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-danger" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>';
                    }


                }
        }
    }

    public static function register(){
        global $dbh;
        if(isset($_POST['register'])){
            if(!$_POST['username']){
                echo '<div id="toast-danger" class="flex items-center p-4 mb-4 w-full max-w-xs text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex flex-shrink-0 justify-center items-center w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            <span class="sr-only">Error icon</span>
        </div>
        <div class="ml-3 text-sm font-normal">Digite um usuário!</div>
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-danger" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>';
            } else if(!$_POST['password']){
                echo 'Digite uma senha';
            } else if(!$_POST['email']){
                echo 'Digite um email';
            } else if(!$_POST['password_repeat']){
                echo 'Repita sua senha!';
            } else if($_POST['password'] != $_POST['password_repeat']){
                echo 'As senhas não se coicidem';
            }else{
                $password = md5(sha1($_POST['password']));
                $sql = $dbh->prepare('SELECT * FROM users WHERE username = :username');
                $sql->bindParam(':username', $_POST['username']);
                $sql->execute();

                $total_registros = $sql->rowCount();
                if($total_registros == 1){
                    echo 'Essa conta já existe!';
                }else if($total_registros == 0){
                    $rank = 1;
                    $sql2 = $dbh->prepare("INSERT INTO users (username, password, email, rank) VALUES (:username, :password, :email, :rank)");
                    $sql2->bindParam(':username', $_POST['username'], PDO::PARAM_STR);
                    $sql2->bindParam(':password', $password, PDO::PARAM_STR);
                    $sql2->bindParam(':email', $_POST['email'], PDO::PARAM_STR);
                    $sql2->bindParam(':rank', $rank);


                    $mensagem =  "Conta registrada username = ". $_POST['username']. " ip =". $_SERVER['HTTP_CF_CONNECTING_IP'];
                    $tipo = "Registro";

                    $logs = $dbh->prepare('INSERT INTO logs(tipo, mensagem, author, data) VALUES (?, ?, ?, ?)');
                    $logs->bindValue(1, $tipo);
                    $logs->bindValue(2, $mensagem);
                    $logs->bindValue(3, $_POST['username']);
                    $logs->bindValue(4, date('d/m/Y H:i'));
                    $logs->execute();

                    if($sql2->execute()){
                        header('Location: ../index');
                        echo 'Conta criada com sucesso!';
                    }
                }
            }
        }
    }
}